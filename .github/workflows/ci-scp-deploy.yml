name: CI Build & SCP Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      BACKEND_DIR: backend/go
      BIN_NAME: gatherup-server
      KEEP_RELEASES: 5

    steps:
      # ---------------------------------------------
      # Checkout code
      # ---------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------
      # Install Go
      # ---------------------------------------------
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # ---------------------------------------------
      # Cache modules
      # ---------------------------------------------
      - name: Cache modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      # ---------------------------------------------
      # Run tests
      # ---------------------------------------------
      - name: Run tests
        run: |
          echo "=== tell every time: running tests ==="
          cd ${{ env.BACKEND_DIR }}
          # Place: tests run from backend/go
          go test ./... -v

      # ---------------------------------------------
      # Build binary (place binary in repo root)
      # ---------------------------------------------
      - name: Build linux binary
        run: |
          echo "=== tell every time: building binary (placing in repo root) ==="
          cd ${{ env.BACKEND_DIR }}
          # Place: working dir = backend/go
          # Place: build target is ../../${{ env.BIN_NAME }} which is repo root ./${{ env.BIN_NAME }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -v -o ../../${{ env.BIN_NAME }} ./cmd/server
          echo "=== tell every time: built binary should be at repo root: ./${{ env.BIN_NAME }} ==="
          ls -l ../../${{ env.BIN_NAME }} || true
          echo "=== tell every time: listing repo root to confirm binary presence ==="
          ls -al ..

      # ---------------------------------------------
      # Validate required secrets
      # ---------------------------------------------
      - name: Validate required secrets
        run: |
          set -euo pipefail
          echo "=== tell every time: validating secrets ==="
          [ -n "${{ secrets.VPS_SSH_KEY }}" ] || { echo "Missing VPS_SSH_KEY"; exit 1; }
          [ -n "${{ secrets.VPS_HOST }}" ] || { echo "Missing VPS_HOST"; exit 1; }
          [ -n "${{ secrets.VPS_USER }}" ] || { echo "Missing VPS_USER"; exit 1; }
          [ -n "${{ secrets.REMOTE_DIR }}" ] || { echo "Missing REMOTE_DIR"; exit 1; }
          [ -n "${{ secrets.SYSTEMD_SERVICE }}" ] || { echo "Missing SYSTEMD_SERVICE"; exit 1; }
          echo "=== tell every time: secrets ok ==="

      # ---------------------------------------------
      # SSH Agent
      # ---------------------------------------------
      - name: Start ssh-agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # ---------------------------------------------
      # Add remote host to known_hosts (safe)
      # ---------------------------------------------
      - name: Add remote host to known_hosts (safe)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          set -euo pipefail
          echo "=== tell every time: adding host to known_hosts ==="
          PORT="${VPS_PORT:-22}"
          ssh-keyscan -p "${PORT}" -H "${VPS_HOST}" >> ~/.ssh/known_hosts
          echo "Host added: ${VPS_HOST}:${PORT}"
          echo "=== tell every time: known_hosts step done ==="

      # ---------------------------------------------
      # Debug listing before SCP (confirm binary location)
      # ---------------------------------------------
      - name: List workspace and backend to confirm binary
        run: |
          echo "=== tell every time: list repo root (expect ./{{ env.BIN_NAME }}) ==="
          ls -al .
          echo "=== tell every time: list backend dir (for reference) ==="
          ls -al ${{ env.BACKEND_DIR }} || true

      # ---------------------------------------------
      # SCP upload (uploads ./gatherup-server from repo root)
      # ---------------------------------------------
      - name: Copy binary to remote host (scp)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -euo pipefail
          echo "=== tell every time: starting SCP upload ==="

          # Place: scp expects local file at repo root: ./${{ env.BIN_NAME }}
          LOCAL_BINARY="./${{ env.BIN_NAME }}"
          echo "=== tell every time: local binary path used by SCP: ${LOCAL_BINARY} ==="
          test -f "${LOCAL_BINARY}" || { echo "ERROR: local binary not found at ${LOCAL_BINARY}"; ls -al .; exit 1; }

          TIMESTAMP=$(date +%s)
          REMOTE_RELEASE_DIR="${REMOTE_DIR}/releases/${TIMESTAMP}"

          echo "Creating directory: $REMOTE_RELEASE_DIR"
          if ! ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" "mkdir -p '${REMOTE_RELEASE_DIR}'"; then
            echo "ERROR: mkdir failed, gathering diagnostics..."
            ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" "
              echo 'whoami:' \$(whoami)
              echo 'id:' \$(id)
              echo 'ls parent:'; ls -ld '${REMOTE_DIR}' || true
            "
            exit 1
          fi

          echo "Uploading binary..."
          scp -P "${VPS_PORT:-22}" "${LOCAL_BINARY}" \
            "${VPS_USER}@${VPS_HOST}:${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}"

          echo "=== tell every time: SCP upload done ==="

      # ---------------------------------------------
      # Install release & restart service
      # ---------------------------------------------
      - name: Install binary and restart service (remote)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          SYSTEMD_SERVICE: ${{ secrets.SYSTEMD_SERVICE }}
        run: |
          set -euo pipefail
          echo "=== tell every time: remote install step ==="

          TIMESTAMP=$(date +%s)
          REMOTE_RELEASE_DIR="${REMOTE_DIR}/releases/${TIMESTAMP}"
          BIN_PATH="${REMOTE_DIR}/${{ env.BIN_NAME }}"

          ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" bash -lc "
            echo '=== tell every time: remote start ==='
            echo 'whoami:' \$(whoami)
            echo 'id:' \$(id)

            sudo mkdir -p '${REMOTE_DIR}' '${REMOTE_DIR}/releases'

            # Place: remote release file will be at ${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}
            sudo ln -sfn '${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}' '${BIN_PATH}'
            sudo chmod +x '${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}'
            sudo chown -R root:root '${REMOTE_DIR}' || true

            cd '${REMOTE_DIR}/releases'
            ls -1t | tail -n +$(( ${KEEP_RELEASES} + 1 )) | xargs -r sudo rm -rf --

            sudo systemctl daemon-reload || true
            sudo systemctl restart '${SYSTEMD_SERVICE}'
            sudo journalctl -u '${SYSTEMD_SERVICE}' -n 80 --no-pager

            echo '=== tell every time: remote done ==='
          "

          echo "=== tell every time: install step finished ==="
