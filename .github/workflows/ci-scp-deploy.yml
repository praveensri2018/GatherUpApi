name: CI Build & SCP Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      BACKEND_DIR: backend/go
      BIN_NAME: gatherup-server
      KEEP_RELEASES: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: Run tests
        run: |
          cd ${{ env.BACKEND_DIR }}
          go test ./... -v

      - name: Build linux binary
        run: |
          cd ${{ env.BACKEND_DIR }}
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -o ../${{ env.BIN_NAME }} ./cmd/server
          ls -l ../${{ env.BIN_NAME }}

      - name: Validate required secrets
        run: |
          set -euo pipefail
          # these expand before the script runs; check presence and fail with clear messages
          [ -n "${{ secrets.VPS_SSH_KEY }}" ] || { echo "Missing secret: VPS_SSH_KEY"; exit 1; }
          [ -n "${{ secrets.VPS_HOST }}" ] || { echo "Missing secret: VPS_HOST"; exit 1; }
          [ -n "${{ secrets.VPS_USER }}" ] || { echo "Missing secret: VPS_USER"; exit 1; }
          [ -n "${{ secrets.REMOTE_DIR }}" ] || { echo "Missing secret: REMOTE_DIR"; exit 1; }
          [ -n "${{ secrets.SYSTEMD_SERVICE }}" ] || { echo "Missing secret: SYSTEMD_SERVICE"; exit 1; }
          echo "All required secrets present."

      - name: Start ssh-agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add remote host to known_hosts (safe)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          set -euo pipefail
          if [ -z "${VPS_HOST}" ]; then
            echo "ERROR: VPS_HOST is empty. Set repository secret VPS_HOST to your server IP/hostname."
            exit 1
          fi

          PORT="${VPS_PORT:-22}"
          echo "Running ssh-keyscan -p ${PORT} ${VPS_HOST}"
          # capture errors to a temp file so we can show a helpful message
          if ! ssh-keyscan -p "${PORT}" -H "${VPS_HOST}" >> ~/.ssh/known_hosts 2>/tmp/sshkeyscan.err; then
            echo "ssh-keyscan failed; last lines of error:"
            tail -n 200 /tmp/sshkeyscan.err || true
            echo "Ensure the host is reachable from GitHub Actions (no firewall) and VPS_HOST is correct."
            exit 1
          fi
          echo "Host added to known_hosts."

      - name: Copy binary to remote host (scp)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +%s)
          REMOTE_RELEASE_DIR="${REMOTE_DIR}/releases/${TIMESTAMP}"
          echo "Creating remote release dir: $REMOTE_RELEASE_DIR"
          ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" "mkdir -p '${REMOTE_RELEASE_DIR}'"
          scp -P "${VPS_PORT:-22}" ./${{ env.BIN_NAME }} "${VPS_USER}@${VPS_HOST}:${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}"

      - name: Install binary and restart service (remote)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          SYSTEMD_SERVICE: ${{ secrets.SYSTEMD_SERVICE }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +%s)
          REMOTE_RELEASE_DIR="${REMOTE_DIR}/releases/${TIMESTAMP}"
          BIN_PATH="${REMOTE_DIR}/${{ env.BIN_NAME }}"
          ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" bash -lc "
            set -euo pipefail
            sudo mkdir -p '${REMOTE_DIR}' '${REMOTE_DIR}/releases'
            sudo ln -sfn '${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}' '${BIN_PATH}'
            sudo chmod +x '${REMOTE_RELEASE_DIR}/${{ env.BIN_NAME }}'
            sudo chown -R root:root '${REMOTE_DIR}' || true
            cd '${REMOTE_DIR}/releases'
            ls -1t | tail -n +$(( ${KEEP_RELEASES} + 1 )) | xargs -r sudo rm -rf --
            sudo systemctl daemon-reload || true
            sudo systemctl restart '${SYSTEMD_SERVICE}'
            sudo journalctl -u '${SYSTEMD_SERVICE}' -n 120 --no-pager -o short-iso
          "
